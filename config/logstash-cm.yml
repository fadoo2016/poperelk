apiVersion: v1
kind: ConfigMap
metadata:
  name: logstash-config
  namespace: elk
data:
  logstash.yml: |
    http.host: 0.0.0.0
    node.name: logstash
    http.port: 9600
    config.reload.automatic: true
    xpack.monitoring.enabled: true
    xpack.monitoring.elasticsearch.username: ${LS_USER}
    xpack.monitoring.elasticsearch.password: ${LS_PWD}
    xpack.monitoring.elasticsearch.hosts: ["http://elasticsearch:9200"]
    xpack.monitoring.collection.interval: 10s

  pipelines.yml: |
    - pipeline.id: syslog-server
      config.string: |
        input { syslog { port => 8088 } }
        output {
          pipeline {
            send_to => [group,combine]
          }
        }
    - pipeline.id: group-processing
      config.string: |
        input {
          pipeline {
            address => group
          }
        }
        filter {
          date {
              match => ["access_time", "dd/MMM/YYYY:HH:mm:ss Z", "UNIX", "yyyy-MM-dd HH:mm:ss", "dd-MMM-yyyy HH:mm:ss"]
              target => "@timestamp"
              timezone => "Asia/Shanghai"
          }

          grok {
            match => {
              "message" => "(?<app_type>heroku router)%{DATA}(?<request_id>(?<=request_id=)[^\s]+)?"
            }
            add_field => { "type" => "heroku" }
          }

          grok {
            match => {
              "message" => "(?<app_type>app web\.\d+)%{DATA}%{COMBINEDAPACHELOG} %{QS:x_forworded_for} - \"(?<request_id>[\w,-]{20,200})\""
            }
            add_field => { "type" => "nginx" }
          }

          grok {
            match => {
              "message" => "(?<app_type>app web\.\d+)%{DATA}\[(?<date>[\d\-\s:]+)\]%{DATA}%{IP:ip}%{DATA}(?<request_id>(?<=request_id:)[\w-]+)%{DATA}(?<role>(?<=role: )[\w-]+)%{DATA}(?<UserID>(?<=UserID:)\d)%{DATA}(?<path>(?<=request:)[^\|]+)%{DATA}:(?<params>[^$]+)"
            }
            add_field => { "type" => "laravel" }
          }
        }
        output {
          #stdout {}
          if [type] == "heroku" {
            elasticsearch {
              hosts => ["elasticsearch:9200"]
              index => "heroku"
              user => "${ES_USER}"
              password => "${ES_PWD}"
            }
          }
          if [type] == "nginx" {
            elasticsearch {
              hosts => ["elasticsearch:9200"]
              index => "nginx"
              user => "${ES_USER}"
              password => "${ES_PWD}"
            }
          }
          if [type] == "laravel" {
            elasticsearch {
              hosts => ["elasticsearch:9200"]
              index => "laravel"
              user => "${ES_USER}"
              password => "${ES_PWD}"
            }
          }
        }
    - pipeline.id: combine-processing
      config.string: |
        input {
          pipeline {
            address => combine
          }
        }
        filter {
          mutate {
            gsub => [ "message", "d.8cfd9efd-5870-4ab1-aba8-3a36afb21daa", "" ]
          }

          grok {
            match => {
              "message" => [
                  "(?<request_id>(?<=request_id=)[\w-]{20,200})",
                  "(?<request_id>(?<=request_id:)[\w-]{20,200})",
                  "- \"(?<request_id>[\w,-]{20,200})\""
              ]
            }
          }

          if ([request_id] !~ "[\w,-]{20,200}") {
            drop {}
          }

          ruby {
            init => "@@ruby_tag= ''"
            code => "
                event.set('[ruby_tag]',@@ruby_tag)
                if @@ruby_tag==event.get('[request_id]')
                  event.set('[message]','+LOG:' + event.get('[message]'))
                else
                  @@ruby_tag=event.get('[request_id]')
                  event.set('[type]','combined')
                end
            "
          }
          multiline {
            pattern => "^\+LOG:"
            negate => false
            what => "previous"
          }
        }
        output {
          stdout {}
          elasticsearch {
            hosts => ["elasticsearch:9200"]
            index => "combinded"
            user => "${ES_USER}"
            password => "${ES_PWD}"
          }
        }
